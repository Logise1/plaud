<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Clases - Plaud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        .perspective-1000 {
            perspective: 1000px;
        }

        .transform-style-3d {
            transform-style: preserve-3d;
        }

        .backface-hidden {
            backface-visibility: hidden;
        }

        .rotate-y-180 {
            transform: rotateY(180deg);
        }

        /* Loading animation extension */
        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }

            100% {
                background-position: 1000px 0;
            }
        }

        .animate-shimmer {
            animation: shimmer 2s infinite linear;
            background: linear-gradient(to right, #f1f5f9 4%, #e2e8f0 25%, #f1f5f9 36%);
            background-size: 1000px 100%;
        }
    </style>
    </style>
    <!-- Mermaid JS for Mindmaps -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ startOnLoad: false, theme: 'neutral' });
    </script>
</head>

<body class="bg-slate-50 text-slate-800 min-h-screen font-sans">

    <!-- Navegaci√≥n -->
    <nav class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 text-indigo-600 font-bold text-xl cursor-pointer"
                onclick="showDashboard()">
                <i class="fas fa-book-reader"></i>
                <span>Plaud<span class="text-slate-800">Viewer</span></span>
            </div>
            <a href="grabar.html"
                class="bg-black text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-800 transition-colors">
                <i class="fas fa-plus mr-1"></i> Nueva Grabaci√≥n
            </a>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8">

        <!-- VISTA 1: LISTA DE ASIGNATURAS -->
        <div id="subjectListView">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Mis Asignaturas</h2>
            <div id="subjectsGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                <!-- Se llena con JS -->
                <div class="col-span-full text-center py-20 text-slate-400">
                    <i class="fas fa-circle-notch fa-spin text-4xl mb-4 text-indigo-500"></i>
                    <p>Cargando asignaturas...</p>
                </div>
            </div>
        </div>

        <!-- VISTA 2: LISTA DE CLASES (POR ASIGNATURA) -->
        <div id="classListView" class="hidden">
            <div class="flex items-center gap-4 mb-6">
                <button onclick="showSubjects()" class="p-2 hover:bg-slate-100 rounded-full transition-colors">
                    <i class="fas fa-arrow-left text-slate-600"></i>
                </button>
                <h2 id="currentSubjectTitle" class="text-2xl font-bold text-slate-800">Clases de Matem√°ticas</h2>
            </div>

            <div id="notesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Se llena con JS -->
            </div>
        </div>

        <!-- VISTA 3: DETALLE DE NOTA -->
        <div id="detailView" class="hidden space-y-6">
            <button onclick="showClassList()"
                class="text-slate-500 hover:text-indigo-600 text-sm font-medium flex items-center gap-2 group">
                <i class="fas fa-arrow-left group-hover:-translate-x-1 transition-transform"></i> Volver a la lista
            </button>

            <div
                class="flex flex-col md:flex-row justify-between items-start md:items-center border-b border-slate-200 pb-4 gap-4">
                <div>
                    <h1 id="detailTitle" class="text-3xl font-bold text-slate-900 flex items-center gap-3">
                        <span id="detailEmoji">üìÑ</span>
                        <span id="detailText">Cargando...</span>
                    </h1>
                    <p id="detailDate" class="text-slate-500 text-sm font-mono mt-1 ml-11">Fecha</p>

                    <!-- Stats Display -->
                    <div id="noteStats"
                        class="flex flex-wrap gap-2 md:gap-4 mt-3 ml-11 text-xs md:text-sm text-slate-500 font-mono">
                        <span class="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded border border-slate-200"
                            title="Duraci√≥n">
                            <i class="far fa-clock text-slate-400"></i> <span id="statDisplayTime">--:--</span>
                        </span>
                        <span class="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded border border-slate-200"
                            title="Velocidad">
                            <i class="fas fa-bolt text-indigo-400"></i> <span id="statDisplayWpm">0</span> WPM
                        </span>
                        <span class="flex items-center gap-1.5 bg-slate-50 px-2 py-1 rounded border border-slate-200"
                            title="Palabras Totales">
                            <i class="fas fa-align-left text-emerald-500"></i> <span id="statDisplayWords">0</span>
                            palabras
                        </span>
                    </div>
                </div>
                <div class="flex flex-wrap bg-slate-100 p-1 rounded-lg gap-1">
                    <button onclick="switchTab('summary')" id="btn-summary"
                        class="tab-btn px-3 py-2 rounded-md text-xs font-medium transition-all">Resumen</button>
                    <button onclick="switchTab('flashcards')" id="btn-flashcards"
                        class="tab-btn px-3 py-2 rounded-md text-xs font-medium transition-all text-slate-500 hover:text-slate-700">Cards</button>
                    <button onclick="switchTab('quiz')" id="btn-quiz"
                        class="tab-btn px-3 py-2 rounded-md text-xs font-medium transition-all text-slate-500 hover:text-slate-700">Quiz</button>
                    <!-- BETA Features -->
                    <button onclick="switchTab('mindmap')" id="btn-mindmap"
                        class="tab-btn px-3 py-2 rounded-md text-xs font-medium transition-all text-slate-500 hover:text-slate-700 flex items-center gap-1">
                        Mapa <span class="bg-indigo-600 text-white text-[9px] px-1 rounded font-bold">BETA</span>
                    </button>
                    <button onclick="switchTab('presentation')" id="btn-presentation"
                        class="tab-btn px-3 py-2 rounded-md text-xs font-medium transition-all text-slate-500 hover:text-slate-700 flex items-center gap-1">
                        Slides <span class="bg-indigo-600 text-white text-[9px] px-1 rounded font-bold">BETA</span>
                    </button>
                </div>
            </div>

            <!-- CONTENIDO TABS -->
            <div id="tabContent" class="min-h-[400px]">

                <!-- TAB: RESUMEN -->
                <div id="summaryTab" class="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in">
                    <!-- Estado: Vacio / Generar -->
                    <div id="summaryEmptyState"
                        class="hidden col-span-3 text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                        <div class="mb-4 text-indigo-100">
                            <i class="fas fa-magic text-6xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Este archivo a√∫n no tiene resumen</h3>
                        <p class="text-slate-500 mb-6 max-w-md mx-auto">La transcripci√≥n est√° lista. Genera un resumen
                            inteligente y puntos clave con un clic.</p>
                        <button onclick="generateContent('summary')"
                            class="bg-black text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-800 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                            <i class="fas fa-bolt mr-2 text-indigo-400"></i> Generar Resumen
                        </button>
                    </div>

                    <!-- Estado: Cargando -->
                    <div id="summaryLoading" class="hidden col-span-3 space-y-4">
                        <div class="h-8 bg-slate-200 rounded w-1/3 animate-shimmer"></div>
                        <div class="h-32 bg-slate-200 rounded w-full animate-shimmer"></div>
                        <div class="h-32 bg-slate-200 rounded w-full animate-shimmer"></div>
                    </div>

                    <!-- Estado: Contenido -->
                    <div id="summaryContent" class="hidden contents">
                        <div class="md:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                                <h3 class="font-bold text-lg mb-4 text-slate-900 flex items-center gap-2">
                                    <i class="fas fa-align-left text-indigo-500"></i> Resumen
                                </h3>
                                <p id="summaryText" class="text-slate-700 leading-relaxed whitespace-pre-line"></p>
                            </div>
                            <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                                <h3 class="font-bold text-sm mb-2 text-slate-500 uppercase">Transcripci√≥n Original</h3>
                                <div id="transcriptText"
                                    class="text-xs text-slate-500 max-h-40 overflow-y-auto italic p-2 bg-white rounded border border-slate-200">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                                <h3 class="font-bold text-lg mb-4 text-indigo-900 flex items-center gap-2">
                                    <i class="fas fa-lightbulb text-indigo-500"></i> Puntos Clave
                                </h3>
                                <ul id="keyPointsList" class="space-y-3 text-sm text-indigo-900"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: FLASHCARDS -->
                <div id="flashcardsTab" class="hidden flex flex-col items-center py-8">
                    <!-- Estado: Vacio / Generar -->
                    <div id="flashcardsEmptyState"
                        class="w-full max-w-md text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                        <div class="mb-4 text-indigo-100">
                            <i class="fas fa-layer-group text-6xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Crea tus Flashcards</h3>
                        <p class="text-slate-500 mb-6 px-6">Genera tarjetas de estudio basadas en el contenido de la
                            clase.</p>

                        <div class="px-8 mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-2 text-left">Cantidad de
                                tarjetas</label>
                            <input type="range" id="flashcardAmount" min="3" max="15" value="5"
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                oninput="document.getElementById('fcVal').innerText = this.value">
                            <div class="flex justify-between text-xs text-slate-400 mt-1">
                                <span>3</span>
                                <span id="fcVal" class="font-bold text-indigo-600">5</span>
                                <span>15</span>
                            </div>
                        </div>

                        <button onclick="generateContent('flashcards')"
                            class="bg-black text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-800 transition-all shadow-lg hover:shadow-xl">
                            Generar Flashcards
                        </button>
                    </div>

                    <!-- Estado: Cargando -->
                    <div id="flashcardsLoading"
                        class="hidden w-full max-w-lg h-72 bg-slate-100 rounded-2xl animate-shimmer flex items-center justify-center">
                        <p class="text-slate-400 font-medium animate-pulse">Generando tarjetas...</p>
                    </div>

                    <!-- Estado: Contenido -->
                    <div id="flashcardsContent" class="hidden contents">
                        <div class="w-full max-w-lg h-72 perspective-1000 cursor-pointer group mb-8"
                            onclick="flipCard()">
                            <div id="flashcardInner"
                                class="relative w-full h-full transition-transform duration-500 transform-style-3d shadow-xl rounded-2xl">
                                <!-- Front -->
                                <div
                                    class="absolute w-full h-full backface-hidden bg-white border border-slate-200 rounded-2xl flex flex-col items-center justify-center p-8 text-center">
                                    <div
                                        class="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center mb-4 text-indigo-500">
                                        <i class="fas fa-question text-xl"></i>
                                    </div>
                                    <span
                                        class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Pregunta</span>
                                    <p id="cardFront" class="text-xl font-medium text-slate-800 leading-snug">¬ø?</p>
                                    <p class="absolute bottom-4 text-xs text-slate-400">Clic para voltear</p>
                                </div>
                                <!-- Back -->
                                <div
                                    class="absolute w-full h-full backface-hidden bg-gradient-to-br from-indigo-600 to-purple-700 text-white rounded-2xl flex flex-col items-center justify-center p-8 text-center rotate-y-180">
                                    <div
                                        class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mb-4 text-white">
                                        <i class="fas fa-check text-xl"></i>
                                    </div>
                                    <span
                                        class="text-xs font-bold text-indigo-200 uppercase tracking-widest mb-2">Respuesta</span>
                                    <p id="cardBack" class="text-xl font-medium leading-snug">Respuesta</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-6">
                            <button onclick="prevCard()"
                                class="p-4 bg-white border border-slate-200 rounded-full hover:bg-slate-50 shadow-sm text-slate-600 hover:text-indigo-600 transition-all">
                                <i class="fas fa-chevron-left text-xl"></i>
                            </button>
                            <span id="cardCounter" class="font-mono text-slate-400 font-medium">1 / 5</span>
                            <button onclick="nextCard()"
                                class="p-4 bg-white border border-slate-200 rounded-full hover:bg-slate-50 shadow-sm text-slate-600 hover:text-indigo-600 transition-all">
                                <i class="fas fa-chevron-right text-xl"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- TAB: QUIZ -->
                <div id="quizTab" class="hidden max-w-2xl mx-auto">
                    <!-- Estado: Vacio / Generar -->
                    <div id="quizEmptyState"
                        class="w-full text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                        <div class="mb-4 text-indigo-100">
                            <i class="fas fa-clipboard-check text-6xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Generador de Quiz</h3>
                        <p class="text-slate-500 mb-6 px-6">Pon a prueba tu conocimiento con preguntas generadas por IA.
                        </p>

                        <div class="grid grid-cols-2 gap-4 max-w-md mx-auto mb-6">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Preguntas</label>
                                <select id="quizAmount" class="w-full p-2 border border-slate-200 rounded-lg">
                                    <option value="3">3 Preguntas</option>
                                    <option value="5" selected>5 Preguntas</option>
                                    <option value="10">10 Preguntas</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Dificultad</label>
                                <select id="quizDifficulty" class="w-full p-2 border border-slate-200 rounded-lg">
                                    <option value="F√°cil">F√°cil</option>
                                    <option value="Media" selected>Media</option>
                                    <option value="Dif√≠cil">Dif√≠cil</option>
                                </select>
                            </div>
                        </div>

                        <button onclick="generateContent('quiz')"
                            class="bg-black text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-800 transition-all shadow-lg hover:shadow-xl">
                            Generar Quiz
                        </button>
                    </div>

                    <!-- Estado: Cargando -->
                    <div id="quizLoading" class="hidden space-y-4">
                        <div class="h-8 bg-slate-200 rounded w-1/4 animate-shimmer"></div>
                        <div class="h-20 bg-slate-200 rounded w-full animate-shimmer"></div>
                        <div class="space-y-2">
                            <div class="h-12 bg-slate-200 rounded w-full animate-shimmer"></div>
                            <div class="h-12 bg-slate-200 rounded w-full animate-shimmer"></div>
                            <div class="h-12 bg-slate-200 rounded w-full animate-shimmer"></div>
                        </div>
                    </div>

                    <!-- Estado: Contenido -->
                    <div id="quizContent" class="hidden contents">
                        <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                            <!-- Header Quiz -->
                            <div class="flex justify-between items-center mb-8 pb-4 border-b border-slate-100">
                                <span id="quizProgress"
                                    class="text-sm font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full">Pregunta
                                    1</span>
                                <span id="quizScore" class="text-sm font-medium text-slate-500">Puntos: 0</span>
                            </div>

                            <!-- Pregunta -->
                            <h3 id="quizQuestion" class="text-xl font-bold text-slate-900 mb-6 leading-relaxed">Pregunta
                            </h3>

                            <!-- Opciones -->
                            <div id="quizOptions" class="space-y-3"></div>

                            <!-- Resultado Final -->
                            <div id="quizResult" class="hidden text-center py-8">
                                <div
                                    class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-green-100 text-green-600 mb-4">
                                    <i class="fas fa-trophy text-3xl"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-slate-900 mb-2">¬°Quiz Completado!</h3>
                                <p id="finalScoreText" class="text-slate-600 mb-6">Obtuviste X puntos</p>
                                <button onclick="resetQuiz()"
                                    class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition-colors">
                                    Reiniciar Quiz
                                </button>
                                <button
                                    onclick="document.getElementById('quizContent').classList.add('hidden'); document.getElementById('quizEmptyState').classList.remove('hidden');"
                                    class="block w-full mt-4 text-sm text-slate-400 hover:text-slate-600">
                                    Generar Nuevo Quiz
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB: MIND MAP (BETA) -->
                <div id="mindmapTab" class="hidden">
                    <!-- Estado: Vacio / Generar -->
                    <div id="mindmapEmptyState"
                        class="w-full text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                        <div class="mb-4 text-indigo-100">
                            <i class="fas fa-project-diagram text-6xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Mapa Mental (BETA)</h3>
                        <p class="text-slate-500 mb-6 px-6">Visualiza la estructura de la clase con un diagrama generado
                            por IA.</p>
                        <button onclick="generateContent('mindmap')"
                            class="bg-black text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-800 transition-all shadow-lg">
                            Generar Mapa
                        </button>
                    </div>

                    <!-- Estado: Cargando -->
                    <div id="mindmapLoading"
                        class="hidden flex flex-col items-center justify-center h-64 bg-slate-50 rounded-xl border border-slate-200">
                        <i class="fas fa-circle-notch fa-spin text-indigo-500 text-3xl mb-4"></i>
                        <p class="text-slate-500">Dise√±ando estructura...</p>
                    </div>

                    <!-- Estado: Contenido -->
                    <div id="mindmapContent"
                        class="hidden bg-white p-4 rounded-xl border border-slate-200 overflow-x-auto">
                        <div id="mermaidContainer" class="flex justify-center min-w-[600px]"></div>
                        <div class="text-center mt-4">
                            <p class="text-xs text-slate-400">Generado con Mermaid.js</p>
                        </div>
                    </div>
                </div>

                <!-- TAB: PRESENTATION (BETA) -->
                <div id="presentationTab" class="hidden">
                    <!-- Estado: Vacio / Generar -->
                    <div id="presentationEmptyState"
                        class="w-full text-center py-12 bg-white rounded-xl border border-dashed border-slate-300">
                        <div class="mb-4 text-indigo-100">
                            <i class="fas fa-chalkboard-teacher text-6xl"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Crear Presentaci√≥n (BETA)</h3>
                        <p class="text-slate-500 mb-6 px-6">Genera diapositivas clave para repasar o ense√±ar el tema.
                        </p>

                        <div class="px-8 mb-6 max-w-xs mx-auto">
                            <label class="block text-sm font-medium text-slate-700 mb-2 text-left">N¬∫
                                Diapositivas</label>
                            <input type="range" id="slidesAmount" min="3" max="8" value="5"
                                class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
                                oninput="document.getElementById('slideVal').innerText = this.value">
                            <div class="flex justify-between text-xs text-slate-400 mt-1">
                                <span>3</span>
                                <span id="slideVal" class="font-bold text-indigo-600">5</span>
                                <span>8</span>
                            </div>
                        </div>

                        <button onclick="generateContent('presentation')"
                            class="bg-black text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-800 transition-all shadow-lg">
                            Generar Slides
                        </button>
                    </div>

                    <!-- Estado: Cargando -->
                    <div id="presentationLoading"
                        class="hidden flex flex-col items-center justify-center h-64 bg-slate-50 rounded-xl border border-slate-200">
                        <i class="fas fa-circle-notch fa-spin text-indigo-500 text-3xl mb-4"></i>
                        <p class="text-slate-500">Redactando diapositivas...</p>
                    </div>

                    <!-- Estado: Contenido -->
                    <div id="presentationContent" class="hidden space-y-8">
                        <div id="slidesContainer" class="space-y-6"></div>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        const firebaseConfig = {
            databaseURL: "https://chatpro-23332-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- CONFIGURACI√ìN MISTRAL ---
        const MISTRAL_API_KEY = "evxly62Xv91b752fbnHA2I3HD988C5RT";
        const API_ENDPOINT = "https://api.mistral.ai/v1/chat/completions";

        // Variables Globales
        let allNotes = [];
        let notesBySubject = {};
        let currentSubject = "";
        let currentNote = null;
        let currentCardIndex = 0;
        let currentQuizIndex = 0;
        let quizScore = 0;
        let localData = null; // Para guardar flashcards/quiz localmente

        // --- CARGAR DATOS ---
        const notesRef = ref(db, 'public_notes');
        onValue(notesRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) {
                document.getElementById('subjectsGrid').innerHTML = '<div class="col-span-full">No hay datos.</div>';
                return;
            }

            allNotes = Object.entries(data).map(([key, value]) => ({ id: key, ...value })).reverse();

            // Agrupar por asignatura
            notesBySubject = allNotes.reduce((acc, note) => {
                const sub = note.subject || "Sin Asignatura";
                if (!acc[sub]) acc[sub] = [];
                acc[sub].push(note);
                return acc;
            }, {});

            renderSubjects();
            if (currentSubject) renderClassList(currentSubject); // Refrescar si estamos dentro
        });

        function renderSubjects() {
            const grid = document.getElementById('subjectsGrid');
            grid.innerHTML = '';

            Object.keys(notesBySubject).forEach(sub => {
                const count = notesBySubject[sub].length;
                const div = document.createElement('div');
                div.className = "bg-white p-6 rounded-xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-indigo-300 transition-all cursor-pointer group";
                div.onclick = () => openSubject(sub);
                div.innerHTML = `
                    <div class="w-12 h-12 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center text-2xl mb-4 group-hover:scale-110 transition-transform">
                        <i class="fas fa-folder"></i>
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mb-1">${sub}</h3>
                    <p class="text-sm text-slate-500">${count} clases</p>
                `;
                grid.appendChild(div);
            });
        }

        window.openSubject = (sub) => {
            currentSubject = sub;
            renderClassList(sub);
            document.getElementById('subjectListView').classList.add('hidden');
            document.getElementById('classListView').classList.remove('hidden');
        };

        function renderClassList(sub) {
            document.getElementById('currentSubjectTitle').innerText = sub;
            const grid = document.getElementById('notesGrid');
            grid.innerHTML = '';

            const notes = notesBySubject[sub] || [];
            if (notes.length === 0) {
                grid.innerHTML = '<p class="text-slate-500">No hay clases.</p>';
                return;
            }

            notes.forEach(note => {
                const date = new Date(note.timestamp).toLocaleDateString();
                // T√≠tulo IA o Default
                const title = note.aiTitle || `Clase del ${date}`;
                const emoji = note.aiEmoji || "üìù";

                const card = document.createElement('div');
                card.className = "bg-white p-5 rounded-xl shadow-sm border border-slate-200 hover:shadow-lg hover:border-indigo-300 transition-all cursor-pointer group flex flex-col h-full";
                card.onclick = () => openNote(note);

                // Checar si existe contenido LOCAL
                const local = JSON.parse(localStorage.getItem(`plaud_local_${note.id}`) || '{}');
                const hasFlash = local.flashcards && local.flashcards.length > 0;
                const hasQuiz = local.quiz && local.quiz.length > 0;

                card.innerHTML = `
                    <div class="flex items-center gap-3 mb-3">
                        <span class="text-2xl">${emoji}</span>
                        <h3 class="font-bold text-slate-800 text-lg group-hover:text-indigo-600 transition-colors line-clamp-2">${title}</h3>
                    </div>
                    <div class="pt-4 border-t border-slate-100 mt-auto flex justify-between items-center text-xs text-slate-400">
                        <span class="font-mono">${date}</span>
                        <div class="flex gap-2">
                             ${hasFlash ? `<i class="fas fa-bolt text-indigo-400" title="Flashcards locales"></i>` : ''}
                             ${hasQuiz ? `<i class="fas fa-clipboard-check text-green-400" title="Quiz local"></i>` : ''}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- NAVEGACI√ìN Y VISTAS ---
        window.showSubjects = () => {
            document.getElementById('subjectListView').classList.remove('hidden');
            document.getElementById('classListView').classList.add('hidden');
        };

        window.showDashboard = () => {
            showSubjects(); // Alias legacy
        };

        window.showClassList = () => {
            document.getElementById('classListView').classList.remove('hidden');
            document.getElementById('detailView').classList.add('hidden');
        };

        window.openNote = async (note) => {
            currentNote = note;
            // Cargar datos LOCALES (Flashcards/Quiz)
            localData = JSON.parse(localStorage.getItem(`plaud_local_${note.id}`) || '{}');

            document.getElementById('classListView').classList.add('hidden');
            document.getElementById('detailView').classList.remove('hidden');

            // Header Info
            const dateStr = new Date(note.timestamp).toLocaleString();
            document.getElementById('detailDate').innerText = dateStr;

            if (note.aiTitle) {
                document.getElementById('detailText').innerText = note.aiTitle;
                document.getElementById('detailEmoji').innerText = note.aiEmoji;
            } else {
                document.getElementById('detailText').innerText = "Generando t√≠tulo...";
                document.getElementById('detailEmoji').innerText = "‚ú®";
                // Generar t√≠tulo autom√°ticamente si no existe
                generateTitle(note);
            }

            // --- POPULATE STATS ---
            const words = note.wordCount || (note.transcript ? note.transcript.trim().split(/\s+/).length : 0);
            const sec = note.durationSeconds || 0;
            // Si no hay wpm guardado, calculamos aproximado si hay duraci√≥n, sino 0
            const wpm = note.wpm || (sec > 0 ? Math.round(words / (sec / 60)) : 0);

            const minutes = Math.floor(sec / 60).toString().padStart(2, '0');
            const seconds = (sec % 60).toString().padStart(2, '0');

            document.getElementById('statDisplayTime').innerText = sec > 0 ? `${minutes}:${seconds}` : "--:--";
            document.getElementById('statDisplayWpm').innerText = wpm;
            document.getElementById('statDisplayWords').innerText = words;

            // Resetear tabs
            switchTab('summary');
        };

        window.switchTab = (tabName) => {
            // Estilos Botones
            const activeClass = "bg-white text-indigo-600 shadow-sm".split(" ");
            const inactiveClass = "text-slate-500 hover:text-slate-700".split(" ");

            ['summary', 'flashcards', 'quiz', 'mindmap', 'presentation'].forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                if (t === tabName) {
                    btn.classList.remove(...inactiveClass);
                    btn.classList.add(...activeClass);
                } else {
                    btn.classList.remove(...activeClass);
                    btn.classList.add(...inactiveClass);
                }
            });

            // Visibilidad Contenido
            document.getElementById('flashcardsTab').classList.add('hidden');
            document.getElementById('quizTab').classList.add('hidden');
            document.getElementById('mindmapTab').classList.add('hidden');
            document.getElementById('presentationTab').classList.add('hidden');

            if (tabName === 'summary') {
                document.getElementById('summaryTab').classList.remove('hidden');
                loadSummary();
            } else if (tabName === 'flashcards') {
                document.getElementById('flashcardsTab').classList.remove('hidden');
                document.getElementById('flashcardsTab').classList.add('flex');
                loadFlashcards();
            } else if (tabName === 'quiz') {
                document.getElementById('quizTab').classList.remove('hidden');
                resetQuiz();
            } else if (tabName === 'mindmap') {
                document.getElementById('mindmapTab').classList.remove('hidden');
                loadMindmap();
            } else if (tabName === 'presentation') {
                document.getElementById('presentationTab').classList.remove('hidden');
                loadPresentation();
            }
        };

        // --- L√ìGICA DE TABS ---
        // --- L√ìGICA DE TABS ---
        function loadSummary() {
            const hasSummary = !!currentNote.summary;

            if (hasSummary) {
                document.getElementById('summaryEmptyState').classList.add('hidden');
                document.getElementById('summaryContent').classList.remove('hidden');
                document.getElementById('summaryContent').classList.add('contents'); // Fix for grid layout

                document.getElementById('summaryText').innerText = currentNote.summary;
                document.getElementById('transcriptText').innerText = currentNote.transcript || "Transcripci√≥n no disponible.";

                const ul = document.getElementById('keyPointsList');
                ul.innerHTML = '';
                if (currentNote.keyPoints) {
                    currentNote.keyPoints.forEach(p => {
                        const li = document.createElement('li');
                        li.className = "flex gap-3 items-start p-2 rounded hover:bg-white transition-colors";
                        li.innerHTML = `<i class="fas fa-check-circle text-indigo-500 mt-1 shrink-0"></i> <span>${p}</span>`;
                        ul.appendChild(li);
                    });
                }
            } else {
                document.getElementById('summaryEmptyState').classList.remove('hidden');
                document.getElementById('summaryContent').classList.add('hidden');
                document.getElementById('transcriptText').innerText = currentNote.transcript || ""; // Aun as√≠ cargamos el transcript si queremos verlo
            }
        }

        // --- FLASHCARDS LOGIC ---
        function loadFlashcards() {
            currentCardIndex = 0;
            // Prioridad: LocalStorage > Firebase (legacy)
            const cards = localData.flashcards || currentNote.flashcards || [];

            if (cards && cards.length > 0) {
                document.getElementById('flashcardsEmptyState').classList.add('hidden');
                document.getElementById('flashcardsContent').classList.remove('hidden');
                document.getElementById('flashcardsContent').classList.add('contents');
                updateCardDisplay(cards);
            } else {
                document.getElementById('flashcardsEmptyState').classList.remove('hidden');
                document.getElementById('flashcardsContent').classList.add('hidden');
            }
        }

        window.updateCardDisplay = (cardsOverride = null) => {
            const cards = cardsOverride || localData.flashcards || currentNote.flashcards || [];
            if (cards.length === 0) return;
            // ... resto igual ...

            const card = cards[currentCardIndex];
            document.getElementById('cardFront').innerText = card.front;
            document.getElementById('cardBack').innerText = card.back;
            document.getElementById('cardCounter').innerText = `${currentCardIndex + 1} / ${cards.length}`;

            // Asegurar que muestra el frente al cambiar
            document.getElementById('flashcardInner').classList.remove('rotate-y-180');
        };

        window.flipCard = () => {
            document.getElementById('flashcardInner').classList.toggle('rotate-y-180');
        };

        window.nextCard = () => {
            const cards = localData.flashcards || currentNote.flashcards;
            if (!cards) return;
            currentCardIndex = (currentCardIndex + 1) % cards.length;
            updateCardDisplay(cards);
        };

        window.prevCard = () => {
            const cards = localData.flashcards || currentNote.flashcards;
            if (!cards) return;
            currentCardIndex = (currentCardIndex - 1 + cards.length) % cards.length;
            updateCardDisplay(cards);
        };

        // --- QUIZ LOGIC ---
        window.resetQuiz = () => {
            // Prioridad: LocalStorage > Firebase
            const quiz = localData.quiz || currentNote.quiz || [];

            if (quiz && quiz.length > 0) {
                document.getElementById('quizEmptyState').classList.add('hidden');
                document.getElementById('quizContent').classList.remove('hidden');
                document.getElementById('quizContent').classList.add('contents');

                currentQuizIndex = 0;
                quizScore = 0;
                document.getElementById('quizOptions').classList.remove('hidden');
                document.getElementById('quizResult').classList.add('hidden');
                document.getElementById('quizQuestion').classList.remove('hidden');
                document.getElementById('quizProgress').parentElement.classList.remove('hidden');
                loadQuizQuestion(quiz);
            } else {
                document.getElementById('quizEmptyState').classList.remove('hidden');
                document.getElementById('quizContent').classList.add('hidden');
            }
        };

        // --- MIND MAP LOGIC ---
        function loadMindmap(mapOverride = null) {
            const mapCode = mapOverride || localData.mindmap || currentNote.mindmap;
            if (mapCode) {
                document.getElementById('mindmapEmptyState').classList.add('hidden');
                document.getElementById('mindmapContent').classList.remove('hidden');

                const container = document.getElementById('mermaidContainer');
                container.innerHTML = `<pre class="mermaid">${mapCode}</pre>`;
                try {
                    mermaid.init(undefined, container.querySelectorAll('.mermaid'));
                } catch (e) { console.error("Mermaid error", e); }
            } else {
                document.getElementById('mindmapEmptyState').classList.remove('hidden');
                document.getElementById('mindmapContent').classList.add('hidden');
            }
        }

        // --- PRESENTATION LOGIC ---
        function loadPresentation(slidesOverride = null) {
            const slides = slidesOverride || localData.presentation || currentNote.presentation;
            if (slides && slides.length > 0) {
                document.getElementById('presentationEmptyState').classList.add('hidden');
                document.getElementById('presentationContent').classList.remove('hidden');

                const container = document.getElementById('slidesContainer');
                container.innerHTML = '';

                slides.forEach((slide, idx) => {
                    const slideDiv = document.createElement('div');
                    slideDiv.className = "bg-white p-6 md:p-8 rounded-xl shadow-lg border border-slate-200 aspect-video flex flex-col justify-center relative overflow-hidden";

                    // Background decoration
                    slideDiv.innerHTML = `
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-6xl text-indigo-500 font-bold font-serif">
                            ${idx + 1}
                        </div>
                        <h2 class="text-2xl md:text-3xl font-bold text-slate-800 mb-6 border-b-2 border-indigo-500 pb-2 w-fit pr-8">${slide.title}</h2>
                        <ul class="space-y-3 text-lg text-slate-600 list-disc pl-6 marker:text-indigo-400">
                            ${slide.points.map(p => `<li>${p}</li>`).join('')}
                        </ul>
                     `;
                    container.appendChild(slideDiv);
                });

            } else {
                document.getElementById('presentationEmptyState').classList.remove('hidden');
                document.getElementById('presentationContent').classList.add('hidden');
            }
        }

        function loadQuizQuestion(quizOverride = null) {
            const quiz = quizOverride || localData.quiz || currentNote.quiz || [];
            if (quiz.length === 0) {
                document.getElementById('quizQuestion').innerText = "No hay quiz disponible para esta nota.";
                return;
            }
            if (currentQuizIndex >= quiz.length) {
                showQuizResult();
                return;
            }

            const q = quiz[currentQuizIndex];
            document.getElementById('quizQuestion').innerText = q.question;
            document.getElementById('quizProgress').innerText = `Pregunta ${currentQuizIndex + 1} / ${quiz.length}`;
            document.getElementById('quizScore').innerText = `Puntos: ${quizScore}`;

            const optionsDiv = document.getElementById('quizOptions');
            optionsDiv.innerHTML = '';

            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl border border-slate-200 hover:border-indigo-500 hover:bg-indigo-50 transition-all font-medium text-slate-700 relative overflow-hidden group";
                btn.innerHTML = `<span class="relative z-10">${opt}</span>`;
                btn.onclick = () => checkAnswer(idx, q.correctAnswer, btn);
                optionsDiv.appendChild(btn);
            });
        }

        function checkAnswer(selected, correct, btnElement) {
            const buttons = document.getElementById('quizOptions').children;
            for (let btn of buttons) {
                btn.disabled = true; // Bloquear
                btn.classList.add('opacity-50', 'cursor-not-allowed');
            }
            btnElement.classList.remove('opacity-50');
            btnElement.classList.add('opacity-100');

            if (selected === correct) {
                btnElement.classList.remove('border-slate-200', 'hover:bg-indigo-50');
                btnElement.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                btnElement.innerHTML += ' <i class="fas fa-check float-right mt-1"></i>';
                quizScore++;
            } else {
                btnElement.classList.remove('border-slate-200', 'hover:bg-indigo-50');
                btnElement.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                btnElement.innerHTML += ' <i class="fas fa-times float-right mt-1"></i>';

                // Mostrar correcta
                const correctBtn = buttons[correct];
                correctBtn.classList.remove('opacity-50', 'border-slate-200');
                correctBtn.classList.add('bg-green-50', 'border-green-500', 'text-green-800');
                correctBtn.innerHTML += ' <i class="fas fa-check float-right mt-1 opacity-50"></i>';
            }

            setTimeout(() => {
                currentQuizIndex++;
                loadQuizQuestion();
            }, 1500);
        }

        function showQuizResult() {
            document.getElementById('quizOptions').classList.add('hidden');
            document.getElementById('quizQuestion').classList.add('hidden');
            document.getElementById('quizProgress').parentElement.classList.add('hidden');

            const resDiv = document.getElementById('quizResult');
            resDiv.classList.remove('hidden');

            const quiz = localData.quiz || currentNote.quiz || [];
            const total = quiz.length;
            const percentage = Math.round((quizScore / total) * 100);

            document.getElementById('finalScoreText').innerHTML = `
                <span class="text-4xl font-bold text-slate-900 block mb-2">${percentage}%</span>
                Has respondido correctamente ${quizScore} de ${total} preguntas.
            `;
        }

        // --- FUNCIONES IA (Generaci√≥n y T√≠tulos) ---
        async function generateTitle(note) {
            if (note.aiTitle) return; // Ya tiene
            const prompt = `Analiza este texto de clase de ${note.subject}. Genera un JSON con {"title": "T√≠tulo corto y pegadizo de 2 a 4 palabras", "emoji": "Emoji representativo"}. Texto: "${note.transcript.substring(0, 1000)}"`;

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${MISTRAL_API_KEY}` },
                    body: JSON.stringify({ model: "mistral-medium", messages: [{ role: "user", content: prompt }], response_format: { type: "json_object" } })
                });
                const data = await response.json();
                const content = JSON.parse(data.choices[0].message.content);

                // Guardar en Firebase (esto S√ç es p√∫blico/compartido)
                const updates = {};
                updates[`/public_notes/${note.id}/aiTitle`] = content.title;
                updates[`/public_notes/${note.id}/aiEmoji`] = content.emoji;
                await update(ref(db), updates);

                // Actualizar UI si sigue abierto
                if (currentNote && currentNote.id === note.id) {
                    document.getElementById('detailText').innerText = content.title;
                    document.getElementById('detailEmoji').innerText = content.emoji;
                }
            } catch (e) { console.error("Error t√≠tulo IA:", e); }
        }

        // --- L√ìGICA DE GENERACI√ìN IA (CONTENIDO) ---
        window.generateContent = async (type) => {
            const transcript = currentNote.transcript;
            if (!transcript) return alert("Error: No hay transcripci√≥n disponible.");

            // UI Loading State
            document.getElementById(`${type}EmptyState`).classList.add('hidden');
            document.getElementById(`${type}Loading`).classList.remove('hidden');

            const subject = currentNote.subject;
            const contextForAI = transcript.substring(0, 15000); // Limit context

            let prompt = "";
            let jsonKey = "";

            if (type === 'summary') {
                jsonKey = "summary_data";
                prompt = `
                    Act√∫a como un profesor experto de ${subject}.
                    Analiza la siguiente transcripci√≥n.
                    Genera un JSON con:
                    {
                        "summary": "Resumen detallado de la clase (200 palabras)",
                        "keyPoints": ["Punto 1", "Punto 2", "Punto 3..."]
                    }
                    Transcripci√≥n: "${contextForAI}"
                `;
            } else if (type === 'flashcards') {
                const amount = document.getElementById('flashcardAmount').value;
                jsonKey = "flashcards_data";
                prompt = `
                    Genera ${amount} flashcards de estudio para la materia ${subject} basadas en el texto.
                    Formato JSON:
                    {
                        "flashcards": [
                            {"front": "Pregunta", "back": "Respuesta"}
                        ]
                    }
                    Transcripci√≥n: "${contextForAI}"
                `;
            } else if (type === 'quiz') {
                const amount = document.getElementById('quizAmount').value;
                const difficulty = document.getElementById('quizDifficulty').value;
                jsonKey = "quiz_data";
                prompt = `
                    Genera un examen tipo test de ${amount} preguntas con dificultad ${difficulty} sobre ${subject}.
                    Formato JSON:
                    {
                        ]
                    }
                    Transcripci√≥n: "${contextForAI}"
                `;
            } else if (type === 'mindmap') {
                jsonKey = "mindmap_data";
                prompt = `
                    Genera un diagrama Mermaid.js (graph TD) que represente la estructura de esta clase.
                    El c√≥digo debe ser v√°lido para incrustar.
                    Formato JSON:
                    {
                        "mermaidCode": "graph TD; A[Tema Principal] --> B[Subtema 1]; B --> C[Detalle];"
                    }
                    La transcripci√≥n es: "${contextForAI}"
                `;
            } else if (type === 'presentation') {
                const amount = document.getElementById('slidesAmount').value;
                jsonKey = "presentation_data";
                prompt = `
                    Genera el contenido para una presentaci√≥n de ${amount} diapositivas sobre esta clase.
                    Formato JSON:
                    {
                        "slides": [
                            {"title": "T√≠tulo Slide 1", "points": ["Punto clave 1", "Punto clave 2"]},
                            {"title": "T√≠tulo Slide 2", "points": ["..."]}
                        ]
                    }
                    Transcripci√≥n: "${contextForAI}"
                `;
            }

            try {
                // --- LLAMADA A MISTRAL ---
                const response = await fetch(API_ENDPOINT, {
                    method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${MISTRAL_API_KEY}` },
                    body: JSON.stringify({ model: "mistral-medium", messages: [{ role: "user", content: prompt }], response_format: { type: "json_object" } })
                });

                const data = await response.json();
                const content = JSON.parse(data.choices[0].message.content);

                // --- PROCESAMIENTO RESULTADO ---
                let finalData = null;

                if (type === 'summary') {
                    finalData = { summary: content.summary, keyPoints: content.keyPoints };
                } else if (type === 'flashcards') {
                    finalData = { flashcards: content.flashcards };
                } else if (type === 'quiz') {
                    finalData = { quiz: content.quiz };
                } else if (type === 'mindmap') {
                    // Limpieza b√°sica de c√≥digo mermaid por si la AI mete markdown ```
                    let code = content.mermaidCode;
                    code = code.replace(/```mermaid/g, '').replace(/```/g, '').trim();
                    finalData = { mindmap: code };
                } else if (type === 'presentation') {
                    finalData = { presentation: content.slides };
                }

                // --- GUARDAR (Local + Cloud) ---
                // 1. Guardar en LocalStorage para acceso r√°pido
                localData = { ...localData, ...finalData };
                localStorage.setItem(`plaud_local_${currentNote.id}`, JSON.stringify(localData));

                // 2. Guardar en Firebase
                const updates = {};
                if (finalData.summary) {
                    updates[`/public_notes/${currentNote.id}/summary`] = finalData.summary;
                    updates[`/public_notes/${currentNote.id}/keyPoints`] = finalData.keyPoints;
                    // Update currentNote object in memory
                    currentNote.summary = finalData.summary;
                    currentNote.keyPoints = finalData.keyPoints;
                }
                if (finalData.flashcards) {
                    updates[`/public_notes/${currentNote.id}/flashcards`] = finalData.flashcards;
                    currentNote.flashcards = finalData.flashcards;
                }
                if (finalData.quiz) {
                    updates[`/public_notes/${currentNote.id}/quiz`] = finalData.quiz;
                    currentNote.quiz = finalData.quiz;
                }
                if (finalData.mindmap) {
                    updates[`/public_notes/${currentNote.id}/mindmap`] = finalData.mindmap;
                    currentNote.mindmap = finalData.mindmap;
                }
                if (finalData.presentation) {
                    updates[`/public_notes/${currentNote.id}/presentation`] = finalData.presentation;
                    currentNote.presentation = finalData.presentation;
                }

                await update(ref(db), updates);

                // UI Refresh
                document.getElementById(`${type}Loading`).classList.add('hidden');
                if (type === 'summary') loadSummary();
                if (type === 'flashcards') loadFlashcards();
                if (type === 'quiz') resetQuiz();
                if (type === 'mindmap') loadMindmap(finalData.mindmap);
                if (type === 'presentation') loadPresentation(finalData.presentation);

            } catch (error) {
                console.error("Error generando contenido (pre-fetch):", error);
                document.getElementById(`${type}Loading`).classList.add('hidden');
                document.getElementById(`${type}EmptyState`).classList.remove('hidden');
            }
        };
    </script>
</body>

</html>